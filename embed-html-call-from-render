<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root {
    --header-height: 95px;
  }

  html, body {
    margin: 0;
    padding: 0;
    min-height: 100svh;
    width: 100%;
    overflow: auto;
  }

  header, .site-header {
    z-index: 1100;
  }

  #reportWrapper,
  #reportContainer,
  #reportContainer iframe {
    position: fixed;
    top: var(--header-height);
    bottom: 0;
    left: 0;
    width: 100vw !important;

    left: 0;
    width: 100vw !important;
    height: calc(100vh - var(--header-height)) !important;
    max-height: calc(100vh - var(--header-height)) !important;
    max-width: 100vw !important;
    margin: 0;
    padding: 0;
    border: none;
    overflow: auto;
    z-index: 1000;
  }

@supports not (height: 100dvh) {
  #reportWrapper,
  #reportContainer,
  #reportContainer iframe {
    height: calc(100vh - var(--header-height));
  }

  body.admin-bar #reportWrapper,
  body.admin-bar #reportContainer,
  body.admin-bar #reportContainer iframe {
    height: calc(100vh - var(--header-height));
  }
}


  @media (max-width: 767px) {
    :root {
      --header-height: 80px;
    }

    #reportWrapper,
    #reportContainer,
    #reportContainer iframe {
      position: static;
      width: 100%;
      height: calc(100vh - var(--header-height));
      overflow: auto;
    }
  }

  footer, .site-footer {
    display: none !important;
  }

  body.admin-bar #reportWrapper,
  body.admin-bar #reportContainer,
  body.admin-bar #reportContainer iframe {
    top: var(--header-height);
    bottom: 0;
  }

  @supports (height: 100dvh) {
    #reportWrapper,
    #reportContainer,
    #reportContainer iframe {
      height: calc(100dvh - var(--header-height)) !important;
      max-height: calc(100dvh - var(--header-height)) !important;
    }

  body.admin-bar #reportWrapper,
  body.admin-bar #reportContainer,
  body.admin-bar #reportContainer iframe {
    height: calc(100dvh - var(--header-height)) !important;
    max-height: calc(100dvh - var(--header-height)) !important;
  }
}

@supports (height: 100svh) {
  #reportWrapper,
  #reportContainer,
  #reportContainer iframe {
    height: calc(100svh - var(--header-height)) !important;
    max-height: calc(100svh - var(--header-height)) !important;
  }
  body.admin-bar #reportWrapper,
  body.admin-bar #reportContainer,
  body.admin-bar #reportContainer iframe {
    height: calc(100svh - var(--header-height)) !important;
    max-height: calc(100svh - var(--header-height)) !important;
  }
}
</style>
<script>
  function updateHeaderOffset() {
    const header = document.querySelector('header');
    const adminBar = document.getElementById('wpadminbar');
    let offset = 0;
    if (header) {
    const style = getComputedStyle(header);
    offset =
      header.offsetHeight +
      parseFloat(style.marginBottom || '0');
    }
    if (adminBar) {
      offset += adminBar.offsetHeight;
    }
    document.documentElement.style.setProperty('--header-height', offset + 'px');
  }

  document.addEventListener('DOMContentLoaded', updateHeaderOffset);
  window.addEventListener('load', updateHeaderOffset);
  window.addEventListener('resize', updateHeaderOffset);
  });
</script>

<div id="reportWrapper">
  <div id="reportContainer"
     data-report-id="a6479e28-0ed5-4515-90ec-af205f635699"
     data-group-id="5c32a84f-0b3d-406c-9097-4930093e3005"
     data-dataset-id="340c9e95-0459-4b8b-9e36-9c968643d777"
    Loading Power BI...
  </div>
</div>

<script>
  const sdkScript = document.createElement("script");
  sdkScript.src = "https://cdn.jsdelivr.net/npm/powerbi-client@2.21.0/dist/powerbi.min.js";

  sdkScript.onload = () => {
    const container = document.getElementById("reportContainer");
    const configData = window.PowerBIEmbedConfig || {
      reportId: container.dataset.reportId,
      groupId: container.dataset.groupId,
      datasetId: container.dataset.datasetId,
    };

    const url = `https://powerbi-token-server.onrender.com/getEmbedToken?reportId=${configData.reportId}&groupId=${configData.groupId}&datasetId=${configData.datasetId}`;

    fetch(url)
      .then(res => res.json())
      .then(data => {
        if (!data.token || !data.embedUrl) {
          container.innerText = "Invalid token response.";
          console.error("Token response error:", data);
          return;
        }

        const models = window["powerbi-client"].models;
        const config = {
          type: "report",
          id: configData.reportId,
          embedUrl: data.embedUrl,
          accessToken: data.token,
          tokenType: models.TokenType.Embed,
          settings: {
            layoutType: models.LayoutType.Custom,
            panes: {
              navigationPane: { visible: true },
              pageNavigation: {
                visible: true,
                position: models.PageNavigationPosition.Bottom
              }
            }
          }
        };

        container.innerHTML = "";
        const report = powerbi.embed(container, config);
        report.on("loaded", () => console.log("✅ Power BI report loaded"));
        report.on("error", err => {
          console.error("❌ Power BI render error:", err.detail);
          container.innerText = "Power BI failed to render.";
        });
      })
      .catch(err => {
        console.error("Fetch error:", err);
        container.innerText = "Failed to fetch embed token.";
      });
  };

  sdkScript.onerror = () => {
    console.error("❌ Failed to load Power BI SDK");
    document.getElementById("reportContainer").innerText = "Failed to load SDK.";
  };

  document.body.appendChild(sdkScript);
</script>
